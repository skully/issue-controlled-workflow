name: Issue Promotion

on:
  issues:
    types: [edited]

permissions:
  contents: read
  issues: write

jobs:
  promote:
    if: contains(github.event.issue.labels.*.name, 'release')
    runs-on: ubuntu-latest

    steps:
      - name: Extract SHA from label
        id: sha
        run: |
          LABELS='${{ toJson(github.event.issue.labels.*.name) }}'
          SHA=$(echo "$LABELS" | grep -o 'sha:[^"]*' | head -n1 | cut -d':' -f2)
          echo "sha=$SHA" >> $GITHUB_OUTPUT

      - name: Detect promotion checkbox
        id: detect
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body
      
            const line = body
              .split("\n")
              .find(l => l.startsWith("- [x] "))

            if (!line) {
              core.setOutput("skip", "true")
              return
            }

            const env = line.replace("- [x] ", "").trim().toLowerCase()

            core.setOutput("env", env)
            core.setOutput("skip", "false")


      - name: Mark Deploying
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue
            const env = "${{ steps.detect.outputs.env }}"
            const upper = env.toUpperCase()

            let body = issue.body

            const regex = new RegExp(`- \\[x\\] .*${upper}`)
            body = body.replace(
              regex,
              `- ğŸ” ${upper}`
            )

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: body
            })

      - name: Deploy via reusable workflow
        uses: ./.github/workflows/deploy-reusable.yaml
        with:
          environment: ${{ steps.detect.outputs.env }}
          sha: ${{ steps.sha.outputs.sha }}

      - name: Mark Done
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const env = "${{ steps.detect.outputs.env }}"
            const upper = env.toUpperCase()

            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            })

            let lines = issue.body.split("\n")

            const index = lines.findIndex(line =>
              line.trim().startsWith(`- ğŸ” ${upper}`)
            )

            if (index === -1) {
              core.info("Deploying line not found")
              return
            }

            lines[index] = `- âœ… ${upper}`

            if (lines[index + 1]) {
              const nextLine = lines[index + 1].trim()

              if (nextLine.startsWith("- ğŸš« ")) {
                const nextEnv = nextLine.replace("- ğŸš« ", "").trim()
                lines[index + 1] = `- [ ] ${nextEnv}`
              }
            }

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: lines.join("\n")
            })
