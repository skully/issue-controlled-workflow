name: Issue Promotion

on:
  issues:
    types: [edited]

permissions:
  contents: read
  issues: write

jobs:

  prepare:
    if: >
      contains(github.event.issue.labels.*.name, 'release') &&
      github.event.sender.login != 'github-actions[bot]'
    runs-on: ubuntu-latest

    outputs:
      env: ${{ steps.detect.outputs.env }}
      sha: ${{ steps.sha.outputs.sha }}
      skip: ${{ steps.detect.outputs.skip }}

    steps:

      - name: Extract SHA from label
        id: sha
        run: |
          LABELS='${{ toJson(github.event.issue.labels.*.name) }}'
          SHA=$(echo "$LABELS" | grep -o 'sha:[^"]*' | head -n1 | cut -d':' -f2)
          echo "sha=$SHA" >> $GITHUB_OUTPUT

      - name: Detect promotion
        id: detect
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body

            // keres checkboxot
            let line = body
              .split("\n")
              .find(l => l.startsWith("- [x] "))

            if (!line) {
              core.setOutput("skip", "true")
              return
            }

            const env = line.replace("- [x] ", "").trim().toLowerCase()

            core.setOutput("env", env)
            core.setOutput("skip", "false")

      - name: Mark Deploying
        if: steps.detect.outputs.skip != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const env = "${{ steps.detect.outputs.env }}"
            const upper = env.toUpperCase()

            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            })

            let lines = issue.body.split("\n")

            const index = lines.findIndex(line =>
              line.trim().startsWith(`- [x] ${upper}`)
            )

            if (index === -1) {
              core.info("Checkbox not found")
              return
            }

            lines[index] = `- ğŸ” ${upper}`

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: lines.join("\n")
            })

  deploy:
    needs: prepare
    if: needs.prepare.outputs.skip != 'true'
    uses: ./.github/workflows/deploy-reusable.yaml
    with:
      environment: ${{ needs.prepare.outputs.env }}
      sha: ${{ needs.prepare.outputs.sha }}

  done:
    needs:
      - prepare
      - deploy
    runs-on: ubuntu-latest

    steps:
      - name: Mark Done + Unlock Next
        uses: actions/github-script@v7
        with:
          script: |
            const env = "${{ needs.prepare.outputs.env }}"
            const upper = env.toUpperCase()

            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            })

            let lines = issue.body.split("\n")

            const index = lines.findIndex(line =>
              line.trim().startsWith(`- ğŸ” ${upper}`)
            )

            if (index === -1) {
              core.info("Deploying line not found")
              return
            }

            // done
            lines[index] = `- âœ… ${upper}`

            // unlock next
            if (lines[index + 1]) {
              const nextLine = lines[index + 1].trim()

              if (nextLine.startsWith("- ğŸš« ")) {
                const nextEnv = nextLine.replace("- ğŸš« ", "").trim()
                lines[index + 1] = `- [ ] ${nextEnv}`
              }
            }

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: lines.join("\n")
            })
