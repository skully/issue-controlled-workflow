name: Release On Main

on:
  push:
    branches:
      - main



jobs:
  deploy-test:
    uses: ./.github/workflows/deploy-reusable.yaml
    with:
      environment: test
      sha: ${{ github.sha }}

  create-issue:
    needs: deploy-test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - name: Create Release Issue
        uses: actions/github-script@v7
        with:
          script: |
            const sha = context.sha;

            const body = [
            `## ðŸš€ Release ${sha}`,
            ``,
            `Commit: \`${sha}\``,
            ``,
            `### Promotion`,
            ``,
            `- âœ… TEST (automatically deployed)`,
            `- [ ] STAGE`,
            `- ðŸš« PROD`
            ].join("\n");

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Release ${sha}`,
              body: body,
              labels: [
                "release",
                `sha:${sha}`
              ]
            });
