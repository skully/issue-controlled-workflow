name: Release On Main

on:
  push:
    branches:
      - main

jobs:
  deploy-test:
    uses: ./.github/workflows/deploy-reusable.yml
    with:
      environment: test
      sha: ${{ github.sha }}

  create-issue:
    needs: deploy-test
    runs-on: ubuntu-latest

    steps:
      - name: Create Release Issue
        uses: actions/github-script@v7
        with:
          script: |
            const sha = context.sha

            const body = `
## ğŸš€ Release ${sha}

Commit: \`${sha}\`

### Promotion

 âœ… TEST (automatically deployed)
- [ ] ğŸ” STAGE
 ğŸš« PROD
`

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Release ${sha}`,
              body: body,
              labels: [
                "release",
                `sha:${sha}`
              ]
            })
